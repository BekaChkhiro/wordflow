// Prisma Schema for WordFlow

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// მომხმარებელი
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?
  name          String?
  image         String?
  provider      String    @default("credentials") // credentials, google

  // პროგრესი
  currentLevel  String    @default("A1")
  totalXp       Int       @default(0)
  streak        Int       @default(0)
  longestStreak Int       @default(0)
  lastActiveAt  DateTime?
  dailyGoal     Int       @default(10)
  dailyProgress Int       @default(0)

  // პარამეტრები
  theme         String    @default("light") // light, dark
  emailNotifications Boolean @default(true)

  // რელაციები
  progress      UserProgress[]
  mistakes      UserMistake[]
  achievements  UserAchievement[]
  sessions      Session[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// NextAuth სესიები
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ფრაზები
model Phrase {
  id          Int       @id @default(autoincrement())
  english     String
  georgian    String
  level       String    // A1, A2, B1, B2, C1, C2
  category    String

  progress    UserProgress[]
  mistakes    UserMistake[]

  createdAt   DateTime  @default(now())
}

// მომხმარებლის პროგრესი ფრაზებზე
model UserProgress {
  id            String    @id @default(cuid())
  userId        String
  phraseId      Int
  learned       Boolean   @default(false)
  correctCount  Int       @default(0)
  wrongCount    Int       @default(0)
  lastPracticed DateTime?

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  phrase        Phrase    @relation(fields: [phraseId], references: [id], onDelete: Cascade)

  @@unique([userId, phraseId])
}

// მომხმარებლის შეცდომები
model UserMistake {
  id          String    @id @default(cuid())
  userId      String
  phraseId    Int
  mistakeType String    // flashcard, quiz, fill_blank, ordering, matching, typing
  userAnswer  String?
  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  phrase      Phrase    @relation(fields: [phraseId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// მიღწევები/Badges
model Achievement {
  id          String    @id @default(cuid())
  name        String    @unique
  description String
  icon        String
  requirement Int       // რამდენი XP, streak, ან ფრაზა
  type        String    // xp, streak, level, phrases, perfect

  users       UserAchievement[]

  createdAt   DateTime  @default(now())
}

// მომხმარებლის მიღწევები
model UserAchievement {
  id            String    @id @default(cuid())
  userId        String
  achievementId String
  earnedAt      DateTime  @default(now())

  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
}

// პაროლის აღდგენის ტოკენები
model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime

  @@unique([email, token])
}
